
# Webサイトを表示する仕組み

## なにこれ？  
皆さんはChromeやSafariなどのブラウザから、googleやyoutubeなどのWebサイトを表示したことがあるかと思います。  
ただ、どのような仕組みでWebサイトが表示されているかまでは分かってない方もいるのではないでしょうか。

弊社の開発案件ではそのようなブラウザからアクセスするWebサイトを作成することも多く、どのような仕組みかを理解する必要があります。

この記事はWebサイトを表示する仕組みを理解できるようになることを目的としています。


## 対象者
Webサイトを表示する仕組みがいまいちよく分からない人  

## 

## Webサイト表示の流れ
まず初めに、Webサイトを表示する際の大まかな流れを記載します。
その後に、それぞれのフェーズの細かい内容を説明していきます。

1. （人）ブラウザ上にURLを入力


1. （ブラウザ）URLからWebサーバーのIPを取得  
正確にはOSに依頼しています。

1. （ブラウザ）IPを取得したWebサーバーに対して、HTTPと呼ばれる形式のメッセージを送信（HTTPリクエストと呼ばれます。）  
送信する処理はOSに依頼しています。

1. （Webサーバー）HTTPリクエストを受け取り、返却すべきHtmlを用意  
Htmlとはブラウザが画面を描画する為に必要なファイルです。  
このほかにもcssやjavascriptなどのファイルも返却します。  
詳しくは後ほど説明します。  

1. （Webサーバー）HTTP形式のメッセージで用意したHTMLを返却


1. （ブラウザ）HTTPレスポンスからHtmlを取り出し、その内容に応じで画面を描画する。


図



## 各部分の詳細

### （ブラウザ）URLからWebサーバーのIPを取得  
ブラウザがURLからWebサーバーのIPを取得する手順は大まかに以下になります。

1. URLからサーバー名に当たる部分を抜き出し  


ブラウザはまずURLを解析し、URLの中からサーバー名を表す箇所を抜き出します。  
URLはいくつかの要素で構成されています。  

例えば以下のURLがあった場合  

http://yahoo.co.jp/aaa/bbb/ccc  

以下のように分解できます。  

http yahoo.co.jp aaa/bbb/ccc  
ここは図で書くか  

このうちプロトコルの後ろの部分がサーバー名になります。  
正確にはサーバーのドメイン名と呼ばれる情報になります。

URLのどこにどの要素が記載されているかは、後述するHTTPの仕様の一部として規定されています。  
URLの仕様についての詳しい解説は別記事で行います。

2. サーバー名に対応するIPをDNSサーバーに問い合わせる  
実際にサーバーと通信する際は、サーバーのドメイン名では無くIPアドレスが必要になります。  
ドメイン名に対応するIPを取得する為にはDNSという仕組みを利用します。  
詳しい内容はネットワーク的な話になるので省略しますが、DNSサーバーに対してドメインに対するIPを教えて下さいとリクエストすることになります。（ネットワーク的な内容を解説している参考書籍を末尾に記載しています。）  
DNSに問い合わせる機能自体は実際はOSが持っており、ブラウザはOSが提供する機能を利用して問い合わせを行っています。  

図



図
(DNSサーバーはOSに設定されています。例えばWindowsだと以下の画面から設定できます。)  

図  



ちなみにURLのサーバー名部分に直接IPアドレスを記載することも可能です。  
その場合DNSに問い合わせる手順はスキップされます。  


### （ブラウザ）Webサーバーに対してHTTPリクエストを送信  
ブラウザはHTTPリクエストというメッセージを作成し、URLから取得したIPに対して送信します。  

HTTP、HTTPリクエストとは何かについて、以下簡単に説明します。  
(もう少し詳しい説明は別記事で行います。)  

この部分の説明をする為に、まずHTTPについて簡単に説明します。  



> #### HTTPとは  

> ブラウザーなどのウェブクライアントとWebサーバーの間で、HTMLファイルなどのさまざまなデータをやりとりするために使用するプロトコル（通信規約）のことです。  
HTTPの仕様はIETFという標準化団体が策定しています。  
参考：[仕様文書](https://triple-underscore.github.io/rfc-others/RFC2616-ja.html#section-4)  


> HTTPでは、HTTPメッセージと呼ばれる、必要な情報を記述した文字列データをやり取りします。
HTTPでは、HTTPメッセージと呼ばれる文字列データをやり取りして必要な情報を伝え合います。    

> HTTPメッセージには以下の2種類があります。  
> - HTTPリクエスト  
クライアントが送信してサーバーにアクションを起こさせる為のHTTPメッセージ  

> - HTTPレスポンス  
HTTPリクエストに対するサーバーの回答であるHTTPメッセージ  


> 図  


> メッセージの仕様（どこにどんな情報をどうやって記載するか）はHTTPプロトコルの仕様の1部として[規定](https://triple-underscore.github.io/rfc-others/RFC2616-ja.html#section-4)されています。  

> #### HTTPリクエストの内容
> ブラウザがなどのクライアントが送信するHTTPリクエストは、以下のような文字列になります。  
> 例  


> HTTPリクエストは大まかに以下のブロックに分かれます。  
> - 開始行  
要求メソッド、リクエスト対象（絶対URLからプロトコル名とドメイン名を除いたもの）、HTTPプロトコルのバージョン

> - HTTPヘッダー  
サーバーに対してどの種類 (例えば、言語や MIME タイプ) のデータが適切かを示す情報や、サーバーの動作を変える (例えば、すでにキャッシュされている場合は回答を送信しない) データを与えます。これらの HTTP ヘッダーは空行で終わるブロックを構成します。

例  


> - 本文  
最後のブロックは省略可能なデータブロックで、主に POST メソッドで使用される追加のデータを含みます。  



以上が簡単なHTTPの説明になります。  
もう少し詳しい説明は別記事で行います。  

この中で説明したHTTPリクエストを生成し、URLから取得したサーバーIPに対して送信する、という作業をブラウザが行ってくれます。  


### （Webサーバー）HTTPリクエストを受け取り、返却すべきHtmlを用意  

ブラウザから送られてきたHTTPリクエストをWebサーバーが受け取り、Webサーバーアプリに受け渡されます。  


Webサーバーアプリはリクエストの内容を解析し、リクエストの内容によって返すべきコンテンツを準備します。  
今回のような、ブラウザにURLが入力された際のリクエストに対しては、まずHtmlというWebページを表示する為のファイルを返却します。  

どのようなファイルかを返すかは、URLのパスやパラメータによって判断します。  
例えば /mypageなら～  
このような、どのリクエストに対してどのコンテンツを返すかのルールは開発者が決め実装します。

Webページにはヘルプページのような内容が変わらない静的ファイルや、マイページのようにユーザーによって内容が異なる動的ファイルがあります。  

動的ファイルの場合は、javaなどの言語で書かれてアプリケーションを呼び出し、データベースから取り出した情報をもとにHtmlファイルを作成する、といった処理が必要になります。  
このあたりは後で詳しく説明します。  

### （Webサーバー）コンテンツをHTTPレスポンスで返却

HTTPリクエストに対する応答として、WebサーバーはHTTPレスポンスメッセージをブラウザに送信します。  
HTTPレスポンスにはHtmlなどのブラウザ側に返却したいコンテンツ情報が含まれています。  

HTTPレスポンスは、以下のような文字列になります。  
例  



図  

HTTPリクエストと同じく、HTTPレスポンスの構文もHTTPの仕様の一部として定義されています。
以下HTTPレスポンスの構造を簡単に説明します。
- ステータス行  
HTTP レスポンスの開始行はステータス行と呼ばれ、以下の情報を持ちます。  
  - プロトコルバージョン  
通常「HTTP/1.1」です。
  - ステータスコード  
リクエストが成功したか失敗したかを示します。例えば200（成功）,404（Not Found）などです。

  - ステータス文字列  
人間がHTTPメッセージを理解するのを助けるための短いテキストです。


- レスポンスヘッダー  
返却するコンテンツの長さや、サーバー情報などの情報が記載されます。
例


- 本文  
ここに応答したい内容が入ります。  
Htmlファイルを返却したい場合は、Htmlファイルの内容が記述されています。  
404など、応答によっては本文が無いものもあります。  


### （ブラウザ）HTTPレスポンスからHtmlを取り出し、その内容に応じで画面を描画する。

図

ブラウザがWebサーバーから返却されたHttpレスポンスを解析し、その本文からHtmlファイルを読み取ります。  

Htmlにはブラウザが画面のどこに何を描画すべきかの情報が記載されており、ブラウザはその内容に従って画面を描画します。  

例えば、Htmlに`<button>ボタンです</button>`と記載されていた場合、画面には以下のようにボタンが描画されます。  

図  

このように、Htmlに何が書かれていたら画面に何をどう描画するかというルールは、W3CとWHATWGという仕様標準化団体により策定されています。  
策定されて仕様は[HTML Living Standard](https://html.spec.whatwg.org/)という名で公開されています。  



以下Htmlの概要を簡単に説明します。  

#### htmlとは
前述の通り、ブラウザにウェブサイトの構成を伝えるための言語です。  
（このような視覚表現や構造を表現する言語をマークアップ言語といいます。）  

`<`と`>`で囲まれた**タグ**を組み合わせて記述します。  
例えば以下のように記述します。  

`<h1>見出しです</h1>`


左の`<>`で囲まれた部分が**開始タグ**、右の`</>`が**終了タグ**と呼ばれます。  
その中に書かれている`h1`は、そのタグが何であるかを表します。  
例えば`h1`は、見出しとしてタグで囲まれた部分の文字列を強調表示する、という意味があります。  

図  

このようにどのタグが何の意味を持つかは前述した仕様で定義されています。  
他の例として、外部へのリンクを表示する場合は`a`というタグを利用します。  

`<a href='http://google.com'>外部リンクはこちら</a>`  

この場合、`a`というタグ名の横に`href`というものが記載されています。  
これは**属性**とよばれ、タグに情報を付加する為に利用されます。  
属性の種類も仕様で定義されており、複数のタグに使われる属性と、特定のタグにのみ使われる属性があります。  
例えば`href`は`a`タグを使用する際にのみ指定可能な属性で、リンクがクリックされた場合の遷移先URLを記載します。  

このように開始タグ～終了タグまでを**要素**といいます。  

まとめると以下になります。  

図  

htmlはこのような要素を組合せて記述されます。  
要素は並べて記載することも入れ子にする事も可能です。  

例えば、ブラウザで適当なサイトを開き、右クリック→ソースを表示 を選択すると、そのサイトのhtmlを見ることが出来ます。  

図  


#### html以外の画面描画時に使用されるファイル  

htmlにはタグ情報の他に、デザインに関する情報を記載したcssと、ふるまいを定義したjavascriptというものが記載されます。  

画面描画の為にブラウザが使用するものとして、html以外にcss、javascriptと呼ばれるものがあります。  


- css  
HTMLの要素をどのように修飾（表示）するかを指示する仕様の一つです。  
幅・高さ・色など、見た目のデザインに関する情報を記載します。

cssは以下のように記載します。  

例  


この例は、backgroundcolorは背景色を表す、という情報を定義しています。  
このような定義はW3Cという団体によって[策定](https://www.w3.org/Style/CSS/specs.en.html)されています。  

cssの適用方法は3つあります。  

1. タグのstyle属性に直接指定する  

1. `<style>`タグの内部に記載する  

1. 外部ファイルに記載し、`<style>`タグから参照する

style属性に直接記述する方法だとタグが増えた際に管理が大変になるため、外部ファイルとして定義する事も多いです。  

②、③の方法で記載する場合は、***セレクタ***という、どの要素にどの定義を適用するかという情報を記載します。  

セレクタは以下のように記載します。  

例  

これはh1タグの背景色を全て赤色にするという定義です。  
cssでは様々なセレクタを定義できます。  

- タグ


- 特定の属性を持った要素

- 独自の定義

これはhtmlの`class`属性に同様の名前が定義されている要素に適用されます。

cssは他にも特定の属性を持つものを対象にしたり、独自の名前を付けた定義を作成出来ます。  




- Javascript
Webサイトのふるまいを定義する為のプログラミング言語です。  
例えば、あるボタンがおされた際にある処理を行う、などの処理を記述します。

例  

主要なブラウザはjavascriptの実行エンジンを持っており、読み込んだjavascriptを解析して実行します。  

javascriptの仕様も標準化団体によって定められているのですが、以下の2つの仕様があります。  

1. javascript自体の言語仕様  
例えば変数やメソッドの定義の仕方などの基本的な部分の定義です。  
TC39という団体により定義されており、その仕様は[ECMAScript](https://tc39.es/ecma262/)と呼ばれています。  


1. Webブラウザ環境で実行する場合特有の機能の仕様  
html要素の操作など、ブラウザ環境で実行される場合限定の機能の仕様が定義されています。  
(サーバーサイドで動かす場合はこれらの機能は利用できません。)  
こちらはhtmlと同じ[Living Standard](https://html.spec.whatwg.org/)として作成されています。  

javascriptの記載方法も、cssと同じく３つあります。  

1. タグのイベント属性に直接指定する  

1. `<script>`タグの内部に記載する  

1. 外部ファイルに記載し、`<script>`タグから参照する


html、css、javascriptの関連は以下になります。  
- html  
Webサイトの構造（どこに何を表示するか）を定義します。  

- css  
Webサイトのデザインを定義します。  

- javascript  
Webサイトの振る舞いを定義します。  


#### 外部ファイルの読み込み順  

css、javascriptをhtmlとは別ファイルとした場合、1度のHttpリクエストで取得するのではなく、それぞれのファイル毎にHttpリクエストを発行します。  

htmlのタグにはCSSとJavaScriptファイルを読み込むためのタグが用意されています。  

- css
`<style>`タグで指定します。
例

- javascript
`<style>`


これらのファイルは以下のように処理されます。  

1. ブラウザがhtmlファイルを解析

1. htmlファイル内の`<style>`、`<script>`タグで外部ファイルが参照されていた場合、そのURLに対してHttpリクエストを発行し、外部ファイルを取得します。

1. 取得したcssファイル、scriptファイルを解析し、htmlに適用します。  


図




## 仕様の策定について
前述したとおりHTTPやHTMLなどの仕様は仕様策定団体によって定義されており、  
主要なブラウザアプリやWebサーバーアプリはその仕様に準拠する形で実装されています。  

例えばChromeなどのブラウザはHTTPリクエストを送る際、仕様通り先頭行に要求メソッド・リクエスト対象などを記載しますし、apacheなどのWebサーバーアプリは仕様通り先頭行に要求メソッド・リクエスト対象などが書かれている前提で送られてきたHTTPリクエストを解析します。    

このように共通の仕様を前提に各アプリが実装されている為、どのような組合せでもHTTPのやり取りを行えるわけです。  


もし共通の仕様が決まっておらず、例えばChromeはHTTPリクエストの先頭行にURLを記載するが、firefoxは末尾の行で定義する、apacheはリクエストの先頭行にURLが想定で動作するがnginxは末尾の行の前提で動作する、などなってしまうと、特定のブラウザとWebアプリの組合せでしかやりとりが出来なくなってしまいます。  

これはHTML、css、javascriptにも同じことが言えます。  

例えばHTMLに<button>ボタン</button>というタグがあれば画面上にボタンを表示する、という共通のルールに従ってブラウザはHTMLから画面を描画します。  

Windowsのchromもedgeも、iOSのsafariでも、Androidのchromeも全てその仕様に従って画面を描画する為、どのブラウザで見ても同じWebページが閲覧できるわけです。  

これがもしchromeはbuttonタグでボタンを描画するが、edgeではただのラベルを描画する、などなると、各ブラウザ向けに返却するHTMLを変えなくてはいけなくなります。  

このような事態を避ける為に仕様策定団体が存在しており、各アプリの開発ベンダーもそれに従っているわけです。  
この仕様には強制力はありませんが、仕様に準拠していないアプリは扱いにくくなるため利用者が減ってしまいます。  
その為自然とこの仕様に従うようになります。  


#### IEについて
上で共通の仕様を各アプリが準拠していると書きましたが、MicrosoftのIEは共通の仕様にあまり対応していませんでした。  
（大まかな部分は準拠していますが、細かい部分で独自の仕様が定義されていたりしました）  

IEはWindows標準搭載で一定のシェアがある為無視することは出来ず、IEが独自仕様を定義している機能を使う場合、開発者はIE用と他のブラウザ用で２つの実装をコーディングしなくてはいけませんでした。  
（その為非常に嫌われていました）  

ネットで調べ物をするとIEの場合はこうコーディングする、といった情報が書かれている場合がありますが、それは上記の理由の為です。  

IEは2022/9月でサポートが終了しますが、古い業務アプリなどはIEでしか動かないものもあるので注意が必要です。  






・MDN HTTPについての説明サイト  
https://developer.mozilla.org/ja/docs/Web/HTTP


・MDN URLとは何か  
https://developer.mozilla.org/ja/docs/Learn/Common_questions/What_is_a_URL


・サーバー
https://wa3.i-3-i.info/word144.html


・tomcat
https://wa3.i-3-i.info/word12843.html
https://thinkit.co.jp/free/article/0708/2/1
https://agency-star.co.jp/column/tomcat


・アプリケーションサーバー

https://www.otsuka-shokai.co.jp/words/application-server.html

アプリケーションサーバーにはアプリケーションプログラムによって以下のような種類がある。
（1）Java：「Tomcat」「Glass Fish」
（2）PHP：「Apache」
（3）Ruby：「Unicorn」「Thin」「Rainbows」「Puma」

マイクロソフトのIIS（Internet Information Services）はWebサーバーとアプリケーションサーバーの機能を統合しVisual Basic、C#などの言語で記述したプログラムが作動している。

Appサーバーをwebサーバーとして利用しない理由
https://qiita.com/yCroma/items/e46476e2ac7c372bb2a3

2015年Webサーバアーキテクチャ序論
https://blog.yuuk.io/entry/2015-webserver-architecture



・ブラウザ周りの仕様
https://qiita.com/megmogmog1965/items/e180d02be711cecdc038
